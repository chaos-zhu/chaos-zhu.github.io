(window.webpackJsonp=window.webpackJsonp||[]).push([[127],{452:function(t,s,a){"use strict";a.r(s);var e=a(0),r=Object(e.a)({},(function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h1",{attrs:{id:"基于vue的服务端渲染框架"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#基于vue的服务端渲染框架"}},[t._v("#")]),t._v(" 基于Vue的服务端渲染框架")]),t._v(" "),a("h2",{attrs:{id:"一、服务端-server-side-render-渲染"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#一、服务端-server-side-render-渲染"}},[t._v("#")]),t._v(" 一、服务端(Server-Side Render)渲染")]),t._v(" "),a("blockquote",[a("ul",[a("li",[t._v("优点：利于SEO、首屏时间快")])])]),t._v(" "),a("blockquote",[a("ul",[a("li",[t._v("需要权衡的点：部分第三方库执行只能在客户端执行、部署环境要求、优质的服务器配置")])])]),t._v(" "),a("h2",{attrs:{id:"二、创建应用注意点"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#二、创建应用注意点"}},[t._v("#")]),t._v(" 二、创建应用注意点")]),t._v(" "),a("p",[t._v("官方提供的脚手架："),a("strong",[a("a",{attrs:{href:"https://github.com/nuxt/create-nuxt-app",target:"_blank",rel:"noopener noreferrer"}},[t._v("create-nuxt-app"),a("OutboundLink")],1)])]),t._v(" "),a("div",{staticClass:"custom-block warning"},[a("blockquote",[a("p",[t._v("3.0+版本默认已不提供服务框架选择项")])]),t._v(" "),a("p",[t._v("解决: npx create-nuxt-app@2.15.0 XXX")])]),t._v(" "),a("h3",{attrs:{id:"server-frameworker-servermiddleware-如何选择？"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#server-frameworker-servermiddleware-如何选择？"}},[t._v("#")]),t._v(" server frameworker & serverMiddleware 如何选择？")]),t._v(" "),a("p",[a("strong",[t._v("1. koa2、express、micro......")])]),t._v(" "),a("blockquote",[a("p",[t._v("选择自定义的服务器框架, 将Nuxt作为中间件使用.")])]),t._v(" "),a("p",[a("strong",[t._v("2. Nuxt API：serverMiddleware(推荐)")])]),t._v(" "),a("blockquote",[a("ul",[a("li",[t._v("通过Nuxt自身的服务(底层基于connect模块, 同样通过use来挂载中间件, Express就是基于Connect开发的)")])])]),t._v(" "),a("blockquote",[a("ul",[a("li",[t._v("nuxt提供的API，在"),a("strong",[t._v("vue-server-renderer")]),t._v("之前执行且不会通过nuxt服务.")])])]),t._v(" "),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// nuxt.config.js")]),t._v("\nserverMiddleware"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'~/serverMiddleware/test'")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// serverMiddleware/test.js")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("export")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("default")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  path"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'/test'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("handler")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("req"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" res"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" next")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    console"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("req"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    console"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("res"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    res"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("end")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'Everything ok!'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("div",{staticClass:"custom-block warning"},[a("p",[t._v("两种服务的路由优先级高于页面路由, 路由命名需注意")])]),t._v(" "),a("h4",{attrs:{id:"对比"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#对比"}},[t._v("#")]),t._v(" 对比")]),t._v(" "),a("blockquote",[a("p",[t._v("自定义选择服务框架带来的是更高的可扩展性(数据库操作、利用一些插件做负载均衡), 但前端人员可能需要过渡参与后端业务逻辑的开发工作.")])]),t._v(" "),a("blockquote",[a("p",[t._v("使用serverMiddleware能将Nuxt从服务中解耦出来,专注原型业务开发.但随着API的增长, 不易维护")])]),t._v(" "),a("div",{staticClass:"custom-block tip"},[a("blockquote",[a("ul",[a("li",[t._v("中间层: 原本client与server直接通信,在中间添加node层对请求做一次处理, 例如:")])])]),t._v(" "),a("blockquote",[a("p",[t._v("API转发(http-proxy-middleware)")])]),t._v(" "),a("blockquote",[a("p",[t._v("接口聚合: A/B/C系统三个不同接口,在ndoe层做一次聚合,一次性查询三个系统数据")])]),t._v(" "),a("blockquote",[a("p",[t._v("数据缓存(radis): 将不经常变换的数据存入rais, 下次请求直接返回, 减轻服务器压力")])]),t._v(" "),a("blockquote",[a("p",[t._v("接口限流: 将一定时间内的多次请求的IP驳回")])]),t._v(" "),a("blockquote",[a("p",[t._v("日志管理: 封装中间件, 保留重要请求的信息")])]),t._v(" "),a("blockquote",[a("p",[t._v("其他: 鉴权、SSR、监控")])]),t._v(" "),a("p",[t._v("参考文章: "),a("a",{attrs:{href:"https://juejin.cn/post/6918260779472912392",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://juejin.cn/post/6918260779472912392"),a("OutboundLink")],1)])]),t._v(" "),a("h2",{attrs:{id:"其他问题"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#其他问题"}},[t._v("#")]),t._v(" 其他问题")]),t._v(" "),a("h3",{attrs:{id:"请求头-cookie-处理"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#请求头-cookie-处理"}},[t._v("#")]),t._v(" 请求头(cookie)处理")]),t._v(" "),a("p",[t._v("**Vue-spa：**axios客户端发送请求【同域自动带上,跨域需配置credentials】")]),t._v(" "),a("p",[a("strong",[t._v("Nuxt项目：")]),t._v("@nuxt/axios自动转发headers信息")]),t._v(" "),a("p",[a("a",{attrs:{href:"https://github.com/nuxt-community/axios-module/blob/dev/lib/module.js#L107",target:"_blank",rel:"noopener noreferrer"}},[t._v("@nuxt/axios源码参考1"),a("OutboundLink")],1)]),t._v(" "),a("p",[a("a",{attrs:{href:"https://github.com/nuxt-community/axios-module/blob/master/lib/plugin.js#L10",target:"_blank",rel:"noopener noreferrer"}},[t._v("@nuxt/axios源码参考2"),a("OutboundLink")],1)]),t._v(" "),a("h2",{attrs:{id:"项目部署"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#项目部署"}},[t._v("#")]),t._v(" 项目部署")]),t._v(" "),a("h3",{attrs:{id:"pm2"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#pm2"}},[t._v("#")]),t._v(" pm2")]),t._v(" "),a("h4",{attrs:{id:"基本配置"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#基本配置"}},[t._v("#")]),t._v(" 基本配置")]),t._v(" "),a("blockquote",[a("p",[t._v("pm2 start ecosystem.config.js --env uat")])]),t._v(" "),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ecosystem.config.js")]),t._v("\nmodule"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("exports "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  apps"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      name"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'cz-mall-web'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      exec_mode"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'cluster'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      instances"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'1'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      script"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'npm'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      args"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'start'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      log_date_format"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'YYYY-MM-DD HH:mm:ss'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      env"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("NODE_ENV")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'production'")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// process.env.NODE_ENV")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      env_uat"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("CUR_ENV")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'uat'")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// process.env.CUR_ENV")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      env_prod"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("CUR_ENV")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'prod'")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// process.env.CUR_ENV")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("h4",{attrs:{id:"优缺点-针对nuxt项目"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#优缺点-针对nuxt项目"}},[t._v("#")]),t._v(" 优缺点(针对nuxt项目)")]),t._v(" "),a("h5",{attrs:{id:"优点"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#优点"}},[t._v("#")]),t._v(" 优点")]),t._v(" "),a("blockquote",[a("ol",[a("li",[t._v("简单易用, 对前端开发人员友好")])])]),t._v(" "),a("blockquote",[a("ol",{attrs:{start:"2"}},[a("li",[t._v("支持热重启、负载均衡、自带监控、内存控制等")])])]),t._v(" "),a("h5",{attrs:{id:"缺点"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#缺点"}},[t._v("#")]),t._v(" 缺点")]),t._v(" "),a("blockquote",[a("ol",[a("li",[t._v("每次部署nuxt服务需要重新拉取依赖与打包")])])]),t._v(" "),a("blockquote",[a("ol",{attrs:{start:"2"}},[a("li",[t._v("需要区分环境使用不同的npm命令构建")])])]),t._v(" "),a("h3",{attrs:{id:"dockers集群部署"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#dockers集群部署"}},[t._v("#")]),t._v(" dockers集群部署")]),t._v(" "),a("h4",{attrs:{id:"镜像构建配置"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#镜像构建配置"}},[t._v("#")]),t._v(" 镜像构建配置")]),t._v(" "),a("blockquote",[a("p",[a("router-link",{attrs:{to:"/back-end/docker/Dockerfile构建镜像.html"}},[t._v("完整版构建参考")])],1)]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("// Dockerfile\nFROM node:12.20.1-alpine3.11\nENV HOST "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0.0")]),t._v(".0.0\nEXPOSE "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("8000")]),t._v("\nCOPY package.json /\nRUN "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("npm")]),t._v(" config "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("set")]),t._v(" registry https://registry.npm.taobao.org\nRUN "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("npm")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("install")]),t._v("\nCOPY "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(".")]),t._v(" /\nRUN "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("npm")]),t._v(" run build\nCMD "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"npm"')]),t._v(", "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"start"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n")])])]),a("h4",{attrs:{id:"部署优势"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#部署优势"}},[t._v("#")]),t._v(" 部署优势")]),t._v(" "),a("blockquote",[a("ol",[a("li",[t._v("单个镜像在不同环境通用化部署，保障不同环境部署后服务保持一致("),a("strong",[t._v("项目内使用的环境变量取决于系统预置环境变量")]),t._v(")")])])]),t._v(" "),a("blockquote",[a("ol",{attrs:{start:"2"}},[a("li",[t._v("得益于docker打包镜像的"),a("strong",[t._v("分层缓存机制")]),t._v(", 在没有修改过package.json的前提下不需要重新安装依赖. "),a("router-link",{attrs:{to:"/back-end/docker/Dockerfile构建镜像.html"}},[t._v("详见")])],1)])]),t._v(" "),a("h2",{attrs:{id:"遗留的问题"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#遗留的问题"}},[t._v("#")]),t._v(" 遗留的问题")]),t._v(" "),a("blockquote",[a("p",[t._v("有时间源码里找答案系列...")])]),t._v(" "),a("h3",{attrs:{id:"beforecreate-created的执行【为何双端执行-】"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#beforecreate-created的执行【为何双端执行-】"}},[t._v("#")]),t._v(" beforeCreate & created的执行【为何双端执行?】")]),t._v(" "),a("blockquote",[a("p",[t._v("猜测：看了下nuxt源码用到的依赖，里边有vue-server-renderer，在vue源码里有做服务端渲染的判断。猜测是beforeCreate & created这俩钩子是vue-server-renderer用来在服务端填充数据的。asyncData、nuxtServerInit、fetch这些方法是nuxt进一步封装上去的")])]),t._v(" "),a("h3",{attrs:{id:"打包后server-client各自的职责"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#打包后server-client各自的职责"}},[t._v("#")]),t._v(" 打包后server & client各自的职责")]),t._v(" "),a("blockquote",[a("p",[t._v("猜测：server渲染页面完成后, client负责嵌入与Vue实例执行")])])])}),[],!1,null,null,null);s.default=r.exports}}]);